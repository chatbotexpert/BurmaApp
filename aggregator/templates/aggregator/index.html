{% extends 'aggregator/base.html' %}

{% block content %}
<style>
    /* Ultra-Premium Header Styles */
    .feed-header-wrapper {
        position: relative;
        text-align: center;
        margin-bottom: 4rem;
        padding-top: 3rem;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Animated Ambient Background Glow */
    .feed-header-bg-glow {
        position: absolute;
        top: 10%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60vw;
        height: 300px;
        background: radial-gradient(circle at center, rgba(79, 70, 229, 0.15) 0%, rgba(79, 70, 229, 0) 70%);
        filter: blur(60px);
        z-index: 0;
        pointer-events: none;
        animation: pulseGlow 8s ease-in-out infinite alternate;
    }

    body.dark-mode .feed-header-bg-glow {
        background: radial-gradient(circle at center, rgba(99, 102, 241, 0.25) 0%, rgba(15, 23, 42, 0) 70%);
    }

    @keyframes pulseGlow {
        0% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 0.8;
        }

        100% {
            transform: translate(-50%, -50%) scale(1.1);
            opacity: 1;
        }
    }

    .feed-title {
        position: relative;
        z-index: 1;
        font-family: 'Plus Jakarta Sans', var(--font-sans);
        font-size: clamp(2.8rem, 5vw, 4.5rem);
        font-weight: 800;
        letter-spacing: -0.05em;
        line-height: 1.1;
        margin-bottom: 1.35rem;
        /* slightly less to compensate for added padding */
        padding-bottom: 0.15rem;
        /* prevent descenders from being cut off */
        padding-top: 0.1rem;
        /* Dynamic elegant gradient */
        background: linear-gradient(135deg, var(--text-main) 30%, var(--primary) 100%);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        display: inline-block;
    }

    body.dark-mode .feed-title {
        background: linear-gradient(135deg, #ffffff 20%, #818cf8 100%);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 10px 40px rgba(99, 102, 241, 0.2);
    }

    .feed-subtitle {
        position: relative;
        z-index: 1;
        font-size: 1.2rem;
        color: var(--text-secondary);
        max-width: 650px;
        margin: 0 auto 3rem auto;
        line-height: 1.7;
        font-weight: 500;
        letter-spacing: -0.01em;
    }

    /* Next-Gen Glassmorphic Buttons */
    .premium-filter-container {
        position: relative;
        z-index: 100;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1.25rem;
        margin-bottom: 2rem;
    }

    .premium-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.85rem 2rem;
        border-radius: 99px;
        font-family: 'Inter', var(--font-sans);
        font-size: 1rem;
        font-weight: 600;
        letter-spacing: -0.01em;
        /* Apple-esque structural borders and shadows */
        background: var(--surface);
        color: var(--text-main);
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow:
            0 2px 8px -2px rgba(0, 0, 0, 0.05),
            0 8px 24px -4px rgba(0, 0, 0, 0.02),
            inset 0 1px 1px rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        cursor: pointer;
        text-decoration: none;
        overflow: hidden;
        position: relative;
    }

    body.dark-mode .premium-btn {
        background: rgba(30, 41, 59, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow:
            0 4px 12px -2px rgba(0, 0, 0, 0.3),
            inset 0 1px 1px rgba(255, 255, 255, 0.05);
    }

    .premium-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
        opacity: 0;
        transition: opacity 0.3s;
    }

    .premium-btn:hover {
        transform: translateY(-2px);
        border-color: rgba(79, 70, 229, 0.3);
        box-shadow:
            0 12px 28px -6px rgba(79, 70, 229, 0.15),
            0 4px 12px -2px rgba(0, 0, 0, 0.05),
            inset 0 1px 1px rgba(255, 255, 255, 0.9);
        color: var(--primary);
    }

    body.dark-mode .premium-btn:hover {
        border-color: rgba(99, 102, 241, 0.5);
        box-shadow:
            0 12px 30px -6px rgba(99, 102, 241, 0.25),
            0 4px 12px -2px rgba(0, 0, 0, 0.4),
            inset 0 1px 1px rgba(255, 255, 255, 0.1);
        background: rgba(30, 41, 59, 0.9);
    }

    .premium-btn:hover::before {
        opacity: 1;
    }

    .premium-btn:active {
        transform: translateY(1px) scale(0.98);
    }

    .premium-btn svg {
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), color 0.3s;
        color: var(--text-secondary);
        z-index: 1;
        position: relative;
    }

    .premium-btn span {
        z-index: 1;
        position: relative;
    }

    .premium-btn:hover svg {
        transform: scale(1.15);
        color: var(--primary);
    }

    /* Special Styling for the RSS Action Button */
    .premium-btn.rss-btn {
        background: var(--background);
        border: 1px solid rgba(79, 70, 229, 0.2);
    }

    body.dark-mode .premium-btn.rss-btn {
        background: rgba(15, 23, 42, 0.8);
    }
</style>

<div class="feed-header-wrapper">
    <div class="feed-header-bg-glow"></div>
    <h1 class="feed-title">Social Media Aggregator</h1>
    <p class="feed-subtitle">Get the latest news and updates from multiple platforms in one seamless feed.</p>

    <!-- Filter Dropdown -->
    <div class="premium-filter-container">
        <button class="premium-btn" onclick="document.getElementById('filterDropdown').classList.toggle('show')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
            </svg>
            <span>Filter Source</span>
        </button>

        {% if request.GET.type %}
        <button class="premium-btn rss-btn"
            onclick="copySourceRss('{{ request.scheme }}://{{ request.get_host }}/feed/rss?type={{ request.GET.type }}&format=xml', this)"
            title="Copy RSS for {{ request.GET.type }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 11a9 9 0 0 1 9 9" />
                <path d="M4 4a16 16 0 0 1 16 16" />
                <circle cx="5" cy="19" r="1" />
            </svg>
            RSS for {{ request.GET.type|title }}
        </button>
        {% elif not request.GET.source %}
        <button class="premium-btn rss-btn"
            onclick="copySourceRss('{{ request.scheme }}://{{ request.get_host }}/feed/rss?format=xml', this)"
            title="Copy RSS for All Sources">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 11a9 9 0 0 1 9 9" />
                <path d="M4 4a16 16 0 0 1 16 16" />
                <circle cx="5" cy="19" r="1" />
            </svg>
            All RSS
        </button>
        {% endif %}
        <div id="filterDropdown" class="filter-dropdown-content">
            <a href="?" class="{% if not request.GET.source and not request.GET.type %}active{% endif %}">
                All Sources
            </a>
            <a href="?type=FACEBOOK" class="{% if request.GET.type == 'FACEBOOK' %}active{% endif %}">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z" />
                </svg>
                Facebook
            </a>
            <a href="?type=TWITTER" class="{% if request.GET.type == 'TWITTER' %}active{% endif %}">
                <!-- X Logo -->
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 4l11.733 16h4.267l-11.733 -16z" />
                    <path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772" />
                </svg>
                X (Twitter)
            </a>
            <a href="?type=TELEGRAM" class="{% if request.GET.type == 'TELEGRAM' %}active{% endif %}">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M21.198 2.433a2.242 2.242 0 0 0-1.022.215l-8.609 3.33c-2.068.8-4.133 1.598-5.724 2.21a405.15 405.15 0 0 1-2.863 1.13c-1.192.501-1.794.788-2.618 1.55a2.128 2.128 0 0 0-.584 1.166c-.053.475.25.922.658 1.162.774.456 1.701.815 3.036 1.332 1.335.517 2.67 1.034 3.014 1.168a.747.747 0 0 1 .458.75c-.096.58-1.559 9.38-1.7 10.222a1.002 1.002 0 0 0 1.637.787c.75-.625 1.765-1.47 2.502-2.083.737-.613 1.474-1.226 2.147-1.787a.754.754 0 0 1 .98-.016c1.157.962 3.1 2.576 4.382 3.642.531.442 1.294.502 1.889.15a2.203 2.203 0 0 0 .96-1.12c.57-2.31 2.243-9.06 3.123-12.608.88-3.548 1.517-6.115 1.517-6.115a2.228 2.228 0 0 0-1.758-2.583 2.25 2.25 0 0 0-.426-.04z" />
                </svg>
                Telegram
            </a>
            <a href="?type=RSS" class="{% if request.GET.type == 'RSS' %}active{% endif %}">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 11a9 9 0 0 1 9 9" />
                    <path d="M4 4a16 16 0 0 1 16 16" />
                    <circle cx="5" cy="19" r="1" />
                </svg>
                RSS Feed
            </a>
        </div>

        <!-- Script to close dropdown when clicking outside -->
        <script>
            window.onclick = function (event) {
                if (!event.target.closest('.premium-btn') && !event.target.closest('.filter-dropdown-content')) {
                    var dropdowns = document.getElementsByClassName("filter-dropdown-content");
                    for (var i = 0; i < dropdowns.length; i++) {
                        var openDropdown = dropdowns[i];
                        if (openDropdown.classList.contains('show')) {
                            openDropdown.classList.remove('show');
                        }
                    }
                }
            }
        </script>
    </div>

    <!-- Source Filter Bar (Clean & Minimal) -->
    <style>
        .source-tags-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.6rem;
            margin-bottom: 3rem;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .source-tag {
            display: inline-flex;
            align-items: stretch;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            /* Pill shape */
            overflow: hidden;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .source-tag:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .source-tag.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        .source-tag-name {
            display: flex;
            align-items: center;
            padding: 0.4rem 0.6rem 0.4rem 1rem;
            color: var(--text-main);
            text-decoration: none;
            font-weight: 500;
        }

        .source-tag.active .source-tag-name {
            color: white;
        }

        .source-tag-rss {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 1rem 0 0.4rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .source-tag:hover .source-tag-rss {
            color: var(--primary);
        }

        .source-tag.active .source-tag-rss {
            color: rgba(255, 255, 255, 0.7);
        }

        .source-tag.active .source-tag-rss:hover {
            color: white;
        }
    </style>
    <div class="source-tags-container">
        {% for source in sources %}
        <div class="source-tag {% if request.GET.source|add:'0' == source.id %}active{% endif %}">
            <a href="?source={{ source.id }}" class="source-tag-name">
                {{ source.name }}
            </a>
            <button class="source-tag-rss"
                onclick="copySourceRss('{{ request.scheme }}://{{ request.get_host }}/feed/rss?source={{ source.id }}&format=xml', this)"
                title="Copy RSS" aria-label="Copy RSS">
                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 11a9 9 0 0 1 9 9" />
                    <path d="M4 4a16 16 0 0 1 16 16" />
                    <circle cx="5" cy="19" r="1" />
                </svg>
            </button>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Script to handle individual source RSS copying -->
<script>
    function copySourceRss(url, btn) {
        navigator.clipboard.writeText(url).then(function () {
            const originalColor = btn.style.color;
            btn.style.color = 'var(--primary)';
            const icon = btn.innerHTML;
            // Briefly show checkmark
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
            setTimeout(() => {
                btn.innerHTML = icon;
                btn.style.color = originalColor;
            }, 1500);
        }).catch(function (err) {
            console.error('Could not copy text: ', err);
        });
    }
</script>

<div class="feed-grid">
    {% for post in page_obj %}
    <article class="news-card">
        <div class="card-image-container">
            <img src="{{ post.display_image_url }}" alt="" class="card-image" loading="lazy"
                onerror="this.onerror=null; this.src='/static/aggregator/images/placeholder_news.svg';">
        </div>

        <div class="card-content">
            <div class="source-badge">
                <div class="source-info">
                    {% if post.source.icon_url %}
                    <img src="{{ post.source.icon_url }}" alt="" class="source-icon">
                    {% endif %}
                    <span class="source-text">{{ post.source.name }} â€¢ {{ post.published_date|date:"M d" }}</span>
                </div>
                <span class="source-type-tag {{ post.source.source_type|lower }}"
                    title="{{ post.source.get_source_type_display }}">
                    {% if post.source.source_type == 'RSS' %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 11a9 9 0 0 1 9 9" />
                        <path d="M4 4a16 16 0 0 1 16 16" />
                        <circle cx="5" cy="19" r="1" />
                    </svg>
                    {% elif post.source.source_type == 'FACEBOOK' %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z" />
                    </svg>
                    {% elif post.source.source_type == 'TWITTER' %}
                    <!-- X Logo (Approximate) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 4l11.733 16h4.267l-11.733 -16z" />
                        <path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772" />
                    </svg>
                    {% elif post.source.source_type == 'TELEGRAM' %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M21.198 2.433a2.242 2.242 0 0 0-1.022.215l-8.609 3.33c-2.068.8-4.133 1.598-5.724 2.21a405.15 405.15 0 0 1-2.863 1.13c-1.192.501-1.794.788-2.618 1.55a2.128 2.128 0 0 0-.584 1.166c-.053.475.25.922.658 1.162.774.456 1.701.815 3.036 1.332 1.335.517 2.67 1.034 3.014 1.168a.747.747 0 0 1 .458.75c-.096.58-1.559 9.38-1.7 10.222a1.002 1.002 0 0 0 1.637.787c.75-.625 1.765-1.47 2.502-2.083.737-.613 1.474-1.226 2.147-1.787a.754.754 0 0 1 .98-.016c1.157.962 3.1 2.576 4.382 3.642.531.442 1.294.502 1.889.15a2.203 2.203 0 0 0 .96-1.12c.57-2.31 2.243-9.06 3.123-12.608.88-3.548 1.517-6.115 1.517-6.115a2.228 2.228 0 0 0-1.758-2.583 2.25 2.25 0 0 0-.426-.04z" />
                    </svg>
                    {% else %}
                    {{ post.source.get_source_type_display }}
                    {% endif %}
                </span>
            </div>

            <h2 class="card-title">
                <a href="{{ post.url }}" target="_blank">
                    {{ post.title }}
                </a>
            </h2>

            <div class="card-excerpt">
                <style>
                    .content-stack {
                        display: flex;
                        flex-direction: column;
                        gap: 0;
                        border-radius: var(--radius);
                        overflow: hidden;
                        border: 1px solid var(--border);
                    }

                    .content-block {
                        padding: 1.5rem;
                    }

                    .content-block.original {
                        background-color: #ffffff;
                        border-bottom: 1px solid var(--border);
                    }

                    .content-block.translated {
                        background-color: #f8fafc;
                        /* Slate 50 */
                    }

                    .content-block h4 {
                        font-size: 0.7rem;
                        text-transform: uppercase;
                        font-weight: 700;
                        color: var(--text-secondary);
                        margin-bottom: 0.75rem;
                        letter-spacing: 0.05em;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                    }

                    .content-text {
                        font-size: 0.95rem;
                        color: var(--text-main);
                        line-height: 1.7;
                        white-space: pre-wrap;
                    }

                    .content-text p {
                        margin-bottom: 1rem;
                    }

                    .content-text p:last-child {
                        margin-bottom: 0;
                    }
                </style>
                <div class="content-stack">
                    <div class="content-block original">
                        <h4>
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10" />
                                <line x1="2" x2="22" y1="12" y2="12" />
                                <path
                                    d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
                            </svg>
                            Original
                        </h4>
                        <div class="content-text" style="font-family: 'Namkhone', 'Pyidaungsu', sans-serif;">
                            {{ post.original_content|linebreaks }}
                        </div>
                    </div>
                    {% if post.translated_content %}
                    <div class="content-block translated">
                        <h4>
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="m5 8 6 6" />
                                <path d="m4 14 6-6 2-3" />
                                <path d="M2 5h12" />
                                <path d="M7 2h1" />
                                <path d="m22 22-5-10-5 10" />
                                <path d="M14 18h6" />
                            </svg>
                            English
                        </h4>
                        <div class="content-text">
                            {{ post.translated_content|linebreaks }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card-footer">
                <span>{{ post.published_date|timesince }} ago</span>
                <a href="{{ post.url }}" target="_blank" class="read-more">
                    Read More
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14" />
                        <path d="m12 5 7 7-7 7" />
                    </svg>
                </a>
            </div>
        </div>
    </article>
    {% empty %}
    <div
        style="column-span: all; text-align: center; padding: 4rem; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);">
        <h3 style="font-size: 1.5rem; margin-bottom: 1rem; color: var(--text-main);">No News Found</h3>
        <p style="color: var(--text-secondary);">Try running the scraper to fetch the latest updates.</p>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
<div class="pagination">
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.source %}&source={{ request.GET.source }}{% endif %}"
        class="page-link">Previous</a>
    {% endif %}

    {% for page_num in custom_range %}
    {% if page_num == page_obj.paginator.ELLIPSIS %}
    <span class="page-link disabled">...</span>
    {% else %}
    {% if page_num == page_obj.number %}
    <span class="page-link active">{{ page_num }}</span>
    {% else %}
    <a href="?page={{ page_num }}{% if request.GET.source %}&source={{ request.GET.source }}{% endif %}"
        class="page-link">{{ page_num }}</a>
    {% endif %}
    {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.source %}&source={{ request.GET.source }}{% endif %}"
        class="page-link">Next</a>
    {% endif %}
</div>
{% endblock %}